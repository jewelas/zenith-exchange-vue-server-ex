var webworkerMap=JSON.parse(decodeURIComponent(location.search.split("=")[1]));var dir="static";if(webworkerMap.baseDir){dir=webworkerMap.baseDir}importScripts(webworkerMap.baseUrl+dir+"/js/pako.min.js");importScripts(webworkerMap.baseUrl+dir+"/web-worker/utils/"+webworkerMap["common-method"]);importScripts(webworkerMap.baseUrl+dir+"/web-worker/"+webworkerMap.marketData);importScripts(webworkerMap.baseUrl+dir+"/web-worker/"+webworkerMap.depthData);importScripts(webworkerMap.baseUrl+dir+"/web-worker/"+webworkerMap.echartsData);importScripts(webworkerMap.baseUrl+dir+"/web-worker/"+webworkerMap.tradeData);var sendMessage=function sendMessage(type,subType,data){self.postMessage({type:type,data:{type:subType,WsData:data}})};var webSocketUrl=null;var lan=null;var rate=null;var symbolAll=null;var symbolListArr=null;var depthValue=null;var MywebSocket=null;var currentSymbol=null;var marketData={renew:[]};var marketDataKey=[];var rateData=null;var marketTime={socketTime:0,contrastTime:500,outTime:500,timeOut:null};var tradeData=null;var tradeTime={socketTime:0,contrastTime:50,outTime:50,timeOut:null};var curreentDepth=null;var tickData={asks:"",buys:""};var depthTime={socketTime:0,contrastTime:45,outTime:50,timeOut:null};var echartsData={};var echartsTime={socketTime:0,contrastTime:50,outTime:50,timeOut:null};var marketReviewSend=function marketReviewSend(){if(MywebSocket){MywebSocket.send(JSON.stringify({event:"req",params:{channel:"review"}}))}};var markteWsSend=function markteWsSend(type,symbolCurrent,symbolList){if(symbolList&&MywebSocket){var symbolKeys=Object.keys(symbolList);symbolKeys.forEach(function(item){if(symbolList[item].symbol){var symbol=symbolList[item].symbol.toLowerCase();var u=1;if(type==="unsub"&&item===symbolCurrent){u=0}else{u=1}if(MywebSocket&&u){MywebSocket.send(JSON.stringify({event:type,params:{channel:"market_".concat(symbol,"_ticker"),cb_id:symbol}}))}}})}};var tradeWsSend=function tradeWsSend(type,symbolCurrent){if(MywebSocket&&symbolCurrent){var symbolArr=symbolCurrent.toLowerCase().split("/");var symbol=symbolArr[1]?symbolArr[0]+symbolArr[1]:symbolArr[0];var num=100;MywebSocket.send(JSON.stringify({event:type,params:{channel:"market_".concat(symbol,"_trade_ticker"),cb_id:symbol,top:num}}))}};var depthWsSend=function depthWsSend(type,symbolCurrent,depth){if(MywebSocket&&symbolCurrent){var symbolArr=symbolCurrent.toLowerCase().split("/");var symbol=symbolArr[1]?symbolArr[0]+symbolArr[1]:symbolArr[0];MywebSocket.send(JSON.stringify({event:type,params:{channel:"market_".concat(symbol,"_depth_step").concat(depth),cb_id:symbol}}))}};var klineWsSend=function klineWsSend(parameters){var type=parameters.type;var symbol=parameters.symbol;var lastTimeS=parameters.lastTimeS;var lTime=parameters.lTime;var number=parameters.number;var params={channel:"market_".concat(symbol,"_kline_").concat(lastTimeS),cb_id:symbol};if(lTime){params.endIdx=lTime;params.pageSize=number}if(MywebSocket.readyState===1){MywebSocket.send(JSON.stringify({event:type,params:params}))}};var timeoutTop=null;var lockReconnectTop=false;var lockDestroyTop=false;clearTimeout(timeoutTop);var heartCheckTop=function heartCheckTop(){var timeout=30000;if(MywebSocket.readyState!==3){clearTimeout(timeoutTop);if(!lockReconnectTop&&!lockDestroyTop){timeoutTop=setTimeout(function(){console.log("\u672A\u68C0\u6D4B\u5230\u5FC3\u8DF3\u4F53\u5F81");MywebSocket.send("1111");MywebSocket.close()},timeout)}}};var reconnectTop=function reconnectTop(type){if(!lockReconnectTop&&!lockDestroyTop){lockReconnectTop=true;setTimeout(function(){creatWebSocket(type)},3000)}};var creatWebSocket=function creatWebSocket(){if(webSocketUrl){MywebSocket=new WebSocket(webSocketUrl);MywebSocket.binaryType="arraybuffer";webSocketEvent();lockReconnectTop=false}};var ii=0;var webSocketEvent=function webSocketEvent(){MywebSocket.onopen=function(){sendMessage("WEBSOCKET_ON_OPEN",MywebSocket.readyState);heartCheckTop()};MywebSocket.onclose=function(data){reconnectTop();sendMessage("WEBSOCKET_ON_OPEN",false)};MywebSocket.onmessage=function(event){if(!currentSymbol){return false}var symbolArr=currentSymbol.toLowerCase().split("/");var symbol=symbolArr[1]?symbolArr[0]+symbolArr[1]:symbolArr[0];var ua=new Uint8Array(event.data);var data=JSON.parse(pako.inflate(ua,{to:"string"}));var dtype;var symbolType;heartCheckTop();if(data.ping){MywebSocket.send(JSON.stringify({pong:data.ping}))}else{if(data.channel){if(symbolListArr&&symbolListArr.tradeType&&symbolListArr.tradeType==="contract"){dtype=data.channel.split("_")[3];symbolType="".concat(data.channel.split("_")[1],"_").concat(data.channel.split("_")[2])}else{dtype=data.channel.split("_")[2];symbolType=data.channel.split("_")[1]}}if(data.channel==="review"){marketData=data.data;marketData.renew=[];marketDataKey="review";var syAc=currentSymbol.split("/");var sycurrentSymbol="".concat(syAc[0].toLowerCase()).concat(syAc[1].toLowerCase());if(marketData[sycurrentSymbol]){setEchartsData(marketData[sycurrentSymbol].close,"current",symbolAll[currentSymbol])}sendMessage("WEBSOCKET_DATA","MARKET_DATA",setMarketData(symbolAll,marketData,rate,lan))}if(data.tick&&dtype==="ticker"){if(marketData.renew.indexOf(symbolType)===-1){marketData.renew.push(symbolType)}var isFirstMarketData=true;if(marketDataKey.indexOf(symbolType)===-1&&marketDataKey!=="review"){marketDataKey.push(symbolType)}else{isFirstMarketData=false}marketData[symbolType]=data.tick;if(data.ts-marketTime.socketTime>=marketTime.contrastTime||isFirstMarketData){clearTimeout(marketTime.timeOut);marketTime.socketTime=data.ts;sendMessage("WEBSOCKET_DATA","MARKET_DATA",setMarketData(symbolAll,marketData,rate,lan));marketData.renew=[]}else{clearTimeout(marketTime.timeOut);marketTime.timeOut=null;marketTime.timeOut=setTimeout(function(){sendMessage("WEBSOCKET_DATA","MARKET_DATA",setMarketData(symbolAll,marketData,rate,lan));marketData.renew=[]},marketTime.outTime)}}if(data.channel&&data.channel.indexOf("_kline_")>-1){if(data.event_rep&&data.event_rep==="rep"){sendMessage("WEBSOCKET_DATA","KLINE_DATA_REQ",data)}else{sendMessage("WEBSOCKET_DATA","KLINE_DATA_SUB",data)}}if(symbol===symbolType){if(data.tick&&data.channel.indexOf("depth_step")!==-1){ii+=1;var depthClasses="depth_step".concat(curreentDepth);var channelArr=data.channel.split("_");var step=channelArr[channelArr.length-1];if(data.channel.indexOf(depthClasses)!==-1){if(data.tick.side){var tick=data.tick;var diff=1;if(tickData[symbolType]&&tickData[symbolType][tick.side][tick.price]&&tickData[symbolType][tick.side][tick.price][1]>tick.volume){diff=2}tickData[symbolType][tick.side][tick.price]=[tick.price,tick.volume,diff];if(!tickData[symbolType].newData){tickData[symbolType].newData=[tick.price]}else if(tickData[symbolType].newData.indexOf(tick.price)<0){tickData[symbolType].newData.push(tick.price)}if(data.ts-depthTime.socketTime>=depthTime.contrastTime){depthTime.socketTime=data.ts;clearTimeout(depthTime.timeOut);depthTime.timeOut=null;sendMessage("WEBSOCKET_DATA","DEPTH_DATA",setDepthData(symbolAll[currentSymbol],tickData[symbolType],rate,depthValue,lan));if(step==="step0"){sendMessage("WEBSOCKET_DATA","ECHARTS_DATA",setEchartsData(tickData[symbolType],false,symbolAll[currentSymbol]))}tickData[symbolType].newData=[]}else{clearTimeout(depthTime.timeOut);depthTime.timeOut=null;depthTime.timeOut=setTimeout(function(){sendMessage("WEBSOCKET_DATA","DEPTH_DATA",setDepthData(symbolAll[currentSymbol],tickData[symbolType],rate,depthValue,lan));if(step==="step0"){sendMessage("WEBSOCKET_DATA","ECHARTS_DATA",setEchartsData(tickData[symbolType],false,symbolAll[currentSymbol]))}tickData[symbolType].newData=[]},depthTime.outTime)}}else{if(data.tick.asks===null)data.tick.asks=[];if(data.tick.buys===null)data.tick.buys=[];tickData[symbolType]={asks:{},buys:{}};data.tick.asks.forEach(function(item){tickData[symbolType].asks[item[0]]=item});data.tick.buys.forEach(function(item){tickData[symbolType].buys[item[0]]=item});sendMessage("WEBSOCKET_DATA","DEPTH_DATA",setDepthData(symbolAll[currentSymbol],tickData[symbolType],rate,depthValue,lan));if(step==="step0"){sendMessage("WEBSOCKET_DATA","ECHARTS_DATA",setEchartsData(tickData[symbolType],false,symbolAll[currentSymbol]))}}}}if(dtype==="trade"){if(data.event_rep==="rep"){data.data&&setEchartsData(data.data[0],"current",symbolAll[currentSymbol]);var tradeDataRep=setTradeData(symbolAll[currentSymbol],data.data,rate,lan);tradeData=tradeDataRep.tradeData;sendMessage("WEBSOCKET_DATA","TRADE_DATA",tradeDataRep)}if(data.tick&&data.tick.data.length){tradeData.forEach(function(item){item.change=0});data.tick.data.forEach(function(item){item.change=1;tradeData.unshift(item)});if(marketData.renew.indexOf("symbolType")===-1){marketData.renew.push("symbolType")}if(data.ts-tradeTime.socketTime>=tradeTime.contrastTime){clearTimeout(tradeTime.timeOut);tradeTime.socketTime=data.ts;marketData[symbolType].close=tradeData[0]?tradeData[0].price:"";marketData.renew=[symbolType];setEchartsData(tradeData[0],"current",symbolAll[currentSymbol]);sendMessage("WEBSOCKET_DATA","MARKET_DATA",setMarketData(symbolAll,marketData,rate,lan));sendMessage("WEBSOCKET_DATA","TRADE_DATA",setTradeData(symbolAll[currentSymbol],tradeData,rate,lan))}else{clearTimeout(tradeTime.timeOut);tradeTime.timeOut=null;tradeTime.timeOut=setTimeout(function(){marketData[symbolType].close=tradeData[0]?tradeData[0].price:"";setEchartsData(tradeData[0],"current",symbolAll[currentSymbol]);sendMessage("WEBSOCKET_DATA","MARKET_DATA",setMarketData(symbolAll,marketData,rate,lan));sendMessage("WEBSOCKET_DATA","TRADE_DATA",setTradeData(symbolAll[currentSymbol],tradeData,rate,lan))},tradeTime.outTime)}}}}}}};var closeWebSocket=function closeWebSocket(){lockDestroyTop=true;clearTimeout(timeoutTop);MywebSocket.close()};var webSocketSend=function webSocketSend(parameters){var type=parameters.type;var sendType=parameters.sendType;var symbolData=parameters.symbolData;var symbolList=parameters.symbolList;depthValue=parameters.depthValue;currentSymbol=symbolData;if(type==="Review"){marketReviewSend()}if(type==="Market"&&symbolData&&symbolList){markteWsSend(sendType,symbolData,symbolList);symbolListArr=symbolList}if(type==="Trade"&&symbolData){tradeWsSend(sendType,symbolData)}if(type==="Depth"&&symbolData){curreentDepth=symbolList;depthWsSend(sendType,symbolData,curreentDepth)}};self.addEventListener("message",function(event){var data=event.data;if(data.type==="CREAT_WEBSOCKET"){if(!MywebSocket){webSocketUrl=data.data.wsUrl;lan=data.data.lan;rate=data.data.rate;symbolAll=data.data.symbolAll;creatWebSocket(data.data.wsUrl)}else{sendMessage("WEBSOCKET_ON_OPEN",MywebSocket.readyState)}}if(data.type==="CLOSE_WEBSOCKET"){closeWebSocket(data.data)}if(data.type==="WEBSOCKET_SEND"){if(MywebSocket.readyState===1){webSocketSend(data.data)}}if(data.type==="WEBSOCKET_KLINE_SEND"){symbolCurrent=data.symbolCurrent;klineWsSend(data.data)}if(data.type==="TRADE_QUEUE_DATA"){tradeData=data.data}},false);